<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Inspection Report - AVIMS</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="../../js/popMessage.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#137fec", "background-light": "#f6f7f8", "background-dark": "#101922" },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; display: inline-block; vertical-align: middle; }
        .material-symbols-outlined.fill { font-variation-settings: 'FILL' 1; }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display transition-colors duration-200">
    <div class="flex min-h-screen">
        <!-- Employee Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto pt-8">
            <div class="max-w-5xl mx-auto px-8 py-10">
                <!-- Page Heading -->
                <div class="mb-8">
                    <h1 class="text-slate-900 dark:text-white text-3xl font-black tracking-tight mb-2">Inspection Report</h1>
                    <p class="text-slate-600 dark:text-slate-400 text-base">Submit your inspection findings and assessment</p>
                </div>

                <!-- Inspection Info -->
                <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-slate-200 dark:border-slate-800 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div><label class="text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase">Inspection #</label><p id="inspNum" class="text-lg font-bold text-slate-900 dark:text-white">—</p></div>
                        <div><label class="text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase">Claim #</label><p id="claimNum" class="text-lg font-bold text-slate-900 dark:text-white">—</p></div>
                        <div><label class="text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase">Vehicle</label><p id="vehicleInfo" class="text-lg font-bold text-slate-900 dark:text-white">—</p></div>
                        <div><label class="text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase">Location</label><p id="locInfo" class="text-lg font-bold text-slate-900 dark:text-white">—</p></div>
                    </div>
                </div>

                <!-- Form Section -->
                <form id="reportForm" class="space-y-6">
                    <!-- Overall Assessment -->
                    <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-slate-200 dark:border-slate-800">
                        <label class="text-sm font-semibold text-slate-900 dark:text-white block mb-3">Overall Assessment</label>
                        <textarea id="assessment" required placeholder="Describe vehicle condition, damage assessment, and findings..." class="w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white" rows="4"></textarea>
                    </div>

                    <!-- Photo Upload -->
                    <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-slate-200 dark:border-slate-800">
                        <label class="text-sm font-semibold text-slate-900 dark:text-white block mb-3">Upload Photos (Optional)</label>
                        <input type="file" id="photoUpload" multiple accept="image/*" class="w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white" />
                        <p class="text-xs text-slate-500 mt-2">Supported: JPG, PNG (Max 5MB per file)</p>
                    </div>

                    <!-- Condition Checklist -->
                    <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-slate-200 dark:border-slate-800">
                        <label class="text-sm font-semibold text-slate-900 dark:text-white block mb-4">Vehicle Condition Checklist</label>
                        <div class="space-y-3">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="check_exterior" class="w-4 h-4 rounded border-slate-300">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Exterior Damage</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="check_interior" class="w-4 h-4 rounded border-slate-300">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Interior Damage</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="check_mechanical" class="w-4 h-4 rounded border-slate-300">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Mechanical Issues</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="check_electronics" class="w-4 h-4 rounded border-slate-300">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Electronic/Electrical Damage</span>
                            </label>
                        </div>
                    </div>

                    <!-- Claim Amount -->
                    <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-slate-200 dark:border-slate-800">
                        <label class="text-sm font-semibold text-slate-900 dark:text-white block mb-3">Claim Amount *</label>
                        <p class="text-xs text-slate-500 mb-3">Please enter the estimated claim amount based on your inspection findings</p>
                        <div class="flex items-center">
                            <span class="text-slate-600 dark:text-slate-400 mr-2 font-semibold">$</span>
                            <input id="claimAmount" type="number" step="0.01" min="0" required placeholder="0.00" class="flex-1 px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white" />
                        </div>
                    </div>

                    <!-- Confirmation -->
                    <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-slate-200 dark:border-slate-800">
                        <label class="text-sm font-semibold text-slate-900 dark:text-white block mb-4">Status Confirmation</label>
                        <div class="space-y-3">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="radio" name="confirmed" value="true" class="w-4 h-4 rounded-full">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Inspection findings are accurate and complete ✓</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="radio" name="confirmed" value="false" class="w-4 h-4 rounded-full">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Additional inspection may be required ✗</span>
                            </label>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-3 justify-end">
                        <button type="button" onclick="goBack()" class="px-6 py-2 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white rounded-lg font-semibold hover:bg-slate-50 dark:hover:bg-slate-800">Back</button>
                        <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg font-semibold hover:opacity-90">Submit Report</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script src="../js/popMessage.js"></script>
    <script src="../js/employee-sidebar.js"></script>
    <script>
        let inspectionId = null;
        let inspection = null;

        // Get inspection ID from URL - more robust parsing
        function getInspectionIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('inspectionId');
            console.log('URL:', window.location.href);
            console.log('Extracted inspectionId:', id);
            return id ? parseInt(id) : null;
        }

        inspectionId = getInspectionIdFromURL();

        // Load employee sidebar
        function loadSidebar() {
            fetch('../templates/employee-sidebar.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('sidebar-container').innerHTML = html;
                    if (typeof initializeStaffSidebar === 'function') {
                        initializeStaffSidebar();
                    }
                })
                .catch(error => console.error('Error loading sidebar:', error));
        }

        async function loadInspection() {
            if (!inspectionId) {
                console.error('No inspection ID provided');
                showPopMessage('No inspection ID provided. Please select an inspection to review.', 'error');
                setTimeout(() => goBack(), 1500);
                return;
            }

            try {
                console.log('Loading inspection:', inspectionId);
                const response = await fetch(`/api/inspections/${inspectionId}`);
                
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                
                const result = await response.json();
                if (result.success && result.data) {
                    inspection = result.data;
                    displayInspectionInfo();
                    console.log('Inspection loaded:', inspection);
                } else {
                    showPopMessage('Failed to load inspection: ' + (result.message || 'Unknown error'), 'error');
                    setTimeout(() => goBack(), 1500);
                }
            } catch (error) {
                console.error('Error loading inspection:', error);
                showPopMessage('Error loading inspection: ' + error.message, 'error');
                setTimeout(() => goBack(), 1500);
            }
        }

        function displayInspectionInfo() {
            if (!inspection) return;
            document.getElementById('inspNum').textContent = '#' + inspection.inspectionId;
            document.getElementById('claimNum').textContent = '#' + (inspection.claimId || 'N/A');
            document.getElementById('vehicleInfo').textContent = inspection.vehicleName || 'N/A';
            document.getElementById('locInfo').textContent = inspection.inspectionLocation || 'N/A';
        }

        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const assessment = document.getElementById('assessment').value;
            const claimAmount = parseFloat(document.getElementById('claimAmount').value);
            const confirmedRadio = document.querySelector('input[name="confirmed"]:checked');
            const confirmed = confirmedRadio ? confirmedRadio.value === 'true' : false;
            const photoUpload = document.getElementById('photoUpload');
            
            // Get checked conditions for result summary
            const conditions = [];
            if (document.getElementById('check_exterior').checked) conditions.push('Exterior Damage');
            if (document.getElementById('check_interior').checked) conditions.push('Interior Damage');
            if (document.getElementById('check_mechanical').checked) conditions.push('Mechanical Issues');
            if (document.getElementById('check_electronics').checked) conditions.push('Electronic Damage');
            
            const resultSummary = conditions.length > 0 ? conditions.join(', ') : 'No issues detected';
            const documentPath = photoUpload.files.length > 0 ? photoUpload.files[0].name : '';

            if (!assessment.trim()) {
                showPopMessage('Please fill in the assessment', 'error');
                return;
            }

            if (!claimAmount || claimAmount < 0) {
                showPopMessage('Please enter a valid claim amount', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/inspections/${inspectionId}/complete`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        overallAssessment: assessment,
                        result: resultSummary,
                        confirmedCorrect: confirmed,
                        documentPath: documentPath,
                        claimableAmount: claimAmount
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showPopMessage('Inspection report submitted successfully. Notification sent to customer.', 'success');
                    setTimeout(() => goBack(), 1500);
                } else {
                    showPopMessage(result.message || 'Failed to submit report', 'error');
                }
            } catch (error) {
                console.error('Error submitting report:', error);
                showPopMessage(error.message || 'Error submitting report', 'error');
            }
        });

        function goBack() {
            window.location.href = 'InspectionManage.html';
        }

        // Initialize
        console.log('InspectionReport page loaded');
        loadSidebar();
        loadInspection();
    </script>
    <script src="../js/pageLoader.js"></script>
</body>

</html>
