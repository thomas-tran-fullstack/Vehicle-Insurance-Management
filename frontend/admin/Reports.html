<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Reports & Analytics - AVIMS</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
    <script src="../js/config.js"></script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-[#0d141b] dark:text-slate-100">
    <div class="flex h-screen overflow-hidden">
        <div id="sidebar-container"></div>
        <main class="flex-1 overflow-y-auto flex flex-col bg-background-light dark:bg-background-dark">
            <div class="p-8 space-y-6 max-w-7xl mx-auto w-full">
                <!-- Page Heading -->
                <div class="space-y-1">
                    <h2 class="text-3xl font-black tracking-tight dark:text-white">Reports & Analytics</h2>
                    <p class="text-[#4c739a] dark:text-slate-400 text-base">View business performance metrics and insights</p>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">Total Revenue</p>
                            <div class="size-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center">
                                <span class="material-symbols-outlined">trending_up</span>
                            </div>
                        </div>
                        <p id="totalRevenueKPI" class="text-3xl font-bold">$0</p>
                        <p class="text-xs text-slate-500 mt-1">Last 6 months</p>
                    </div>

                    <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">Total Claims</p>
                            <div class="size-10 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-600 flex items-center justify-center">
                                <span class="material-symbols-outlined">warning</span>
                            </div>
                        </div>
                        <p id="totalClaimsKPI" class="text-3xl font-bold">0</p>
                        <p class="text-xs text-slate-500 mt-1">Active claims</p>
                    </div>

                    <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">Loss Ratio</p>
                            <div class="size-10 rounded-lg bg-amber-100 dark:bg-amber-900/30 text-amber-600 flex items-center justify-center">
                                <span class="material-symbols-outlined">assessment</span>
                            </div>
                        </div>
                        <p id="lossRatioKPI" class="text-3xl font-bold">0%</p>
                        <p class="text-xs text-slate-500 mt-1">Claims vs Revenue</p>
                    </div>

                    <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">Active Policies</p>
                            <div class="size-10 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-600 flex items-center justify-center">
                                <span class="material-symbols-outlined">policy</span>
                            </div>
                        </div>
                        <p id="totalPoliciesKPI" class="text-3xl font-bold">0</p>
                        <p class="text-xs text-slate-500 mt-1">Active policies</p>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Revenue vs Expenses Chart -->
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                        <h3 class="text-lg font-bold mb-4">Revenue vs Expenses (6 Months)</h3>
                        <div style="position: relative; height: 300px; width: 100%;">
                            <canvas id="revenueExpensesChart"></canvas>
                        </div>
                    </div>

                    <!-- Claims by Status -->
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                        <h3 class="text-lg font-bold mb-4">Claims Distribution</h3>
                        <div style="position: relative; height: 300px; width: 100%;">
                            <canvas id="claimsDistributionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Export Section -->
                <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <h3 class="text-lg font-bold mb-4">Export Report</h3>
                    <div class="flex gap-3 flex-wrap">
                        <button id="exportPdfBtn" class="px-4 py-2 bg-primary text-white rounded-lg font-bold hover:bg-primary/90 transition-all shadow-sm flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">description</span>
                            <span>Export as PDF</span>
                        </button>
                        <button id="exportExcelBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition-all shadow-sm flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">table_chart</span>
                            <span>Export as Excel</span>
                        </button>
                        <button id="printBtn" class="px-4 py-2 bg-gray-600 text-white rounded-lg font-bold hover:bg-gray-700 transition-all shadow-sm flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">print</span>
                            <span>Print</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/admin-sidebar.js"></script>
    <script>
        if (typeof API_BASE === 'undefined') {
            window.API_BASE = "http://localhost:5169/api";
        }
        let revenueChart, claimsChart;

        // Load sidebar
        fetch("../templates/admin-sidebar.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("sidebar-container").innerHTML = html;
                if (typeof initializeAdminSidebar === "function") {
                    initializeAdminSidebar();
                }
            });

        // Load data on page load
        document.addEventListener("DOMContentLoaded", () => {
            loadKPIs();
            loadCharts();
        });

        // Load KPI data
        async function loadKPIs() {
            try {
                const response = await fetch(`${API_BASE}/report/kpi-summary`);
                const data = await response.json();

                document.getElementById("totalRevenueKPI").textContent = `$${(data.totalRevenue || 0).toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
                document.getElementById("totalClaimsKPI").textContent = (data.totalClaims || 0).toString();
                document.getElementById("lossRatioKPI").textContent = `${((data.lossRatio || 0) * 100).toFixed(1)}%`;
                document.getElementById("totalPoliciesKPI").textContent = (data.totalPolicies || 0).toString();
            } catch (error) {
                console.error("Error loading KPIs:", error);
            }
        }

        // Load charts
        async function loadCharts() {
            try {
                const response = await fetch(`${API_BASE}/report/chart-data`);
                const data = await response.json();

                // Revenue vs Expenses Chart
                const revenueCtx = document.getElementById("revenueExpensesChart").getContext("2d");
                revenueChart = new Chart(revenueCtx, {
                    type: "line",
                    data: {
                        labels: data.months || ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
                        datasets: [
                            {
                                label: "Revenue",
                                data: data.revenues || [0, 0, 0, 0, 0, 0],
                                borderColor: "#137fec",
                                backgroundColor: "rgba(19, 127, 236, 0.1)",
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: "Expenses",
                                data: data.expenses || [0, 0, 0, 0, 0, 0],
                                borderColor: "#ef4444",
                                backgroundColor: "rgba(239, 68, 68, 0.1)",
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: "bottom"
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return "$" + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });

                // Claims Distribution Chart
                const claimsCtx = document.getElementById("claimsDistributionChart").getContext("2d");
                claimsChart = new Chart(claimsCtx, {
                    type: "doughnut",
                    data: {
                        labels: data.claimStatuses || ["Pending", "Approved", "Rejected"],
                        datasets: [
                            {
                                data: data.claimCounts || [10, 20, 5],
                                backgroundColor: [
                                    "#fbbf24",
                                    "#10b981",
                                    "#ef4444"
                                ],
                                borderColor: [
                                    "#d97706",
                                    "#059669",
                                    "#dc2626"
                                ],
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: "bottom"
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error loading charts:", error);
            }
        }

        // Export functions
        document.getElementById("exportPdfBtn").addEventListener("click", () => {
            alert("PDF export functionality coming soon!");
        });

        document.getElementById("exportExcelBtn").addEventListener("click", () => {
            alert("Excel export functionality coming soon!");
        });

        document.getElementById("printBtn").addEventListener("click", () => {
            window.print();
        });
    </script>    <script src="../js/pageLoader.js"></script></body>

</html>
