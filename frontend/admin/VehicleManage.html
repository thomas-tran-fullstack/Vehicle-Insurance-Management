<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Vehicle Management Admin - AVIMS</title>
    <link rel="icon" type="image/png" href="../images/logo.png" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .success-message {
            @apply bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-400 px-4 py-3 rounded-lg flex items-center gap-2 mb-6;
        }

        .error-message {
            @apply bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 px-4 py-3 rounded-lg flex items-center gap-2 mb-6;
        }

        .table-row-hover:hover {
            background-color: rgba(15, 23, 42, 0.03);
        }

        .dark .table-row-hover:hover {
            background-color: rgba(51, 65, 85, 0.5);
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-[#0d141b] transition-colors duration-200">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-background-light dark:bg-background-dark">
            <div class="p-8 max-w-[1400px] mx-auto">
                <!-- Page Header -->
                <div class="mb-8">
                    <h1 class="text-3xl font-black text-[#0d141b] dark:text-white mb-2">Vehicle Management</h1>
                    <p class="text-[#4c739a] dark:text-slate-400">Manage and monitor all vehicles in the system</p>
                </div>

                <!-- Alert Messages -->
                <div id="successMessage" class="success-message hidden">
                    <span class="material-symbols-outlined">check_circle</span>
                    <span id="successText">Operation completed successfully!</span>
                </div>
                <div id="errorMessage" class="error-message hidden">
                    <span class="material-symbols-outlined">error</span>
                    <span id="errorText">An error occurred. Please try again.</span>
                </div>

                <!-- Stats Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-[#cfdbe7] dark:border-slate-800 shadow-sm">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-sm font-medium text-[#4c739a] mb-1">Total Vehicles</p>
                                <p class="text-3xl font-bold text-[#0d141b] dark:text-white" id="totalVehicles">0</p>
                            </div>
                            <div class="p-2 bg-primary/10 rounded-lg text-primary">
                                <span class="material-symbols-outlined">directions_car</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-[#cfdbe7] dark:border-slate-800 shadow-sm">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-sm font-medium text-[#4c739a] mb-1">Active Policies</p>
                                <p class="text-3xl font-bold text-[#0d141b] dark:text-white" id="activePolicies">0</p>
                            </div>
                            <div class="p-2 bg-green-100 dark:bg-green-500/20 rounded-lg text-green-600 dark:text-green-400">
                                <span class="material-symbols-outlined">verified_user</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-[#cfdbe7] dark:border-slate-800 shadow-sm">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-sm font-medium text-[#4c739a] mb-1">Pending Inspections</p>
                                <p class="text-3xl font-bold text-[#0d141b] dark:text-white" id="pendingInspections">0</p>
                            </div>
                            <div class="p-2 bg-orange-100 dark:bg-orange-500/20 rounded-lg text-orange-600 dark:text-orange-400">
                                <span class="material-symbols-outlined">fact_check</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search & Filters & Export -->
                <div class="bg-white dark:bg-slate-900 rounded-xl border border-[#cfdbe7] dark:border-slate-800 mb-6 overflow-hidden shadow-sm">
                    <div class="p-6 border-b border-[#e7edf3] dark:border-slate-800">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
                            <!-- Search -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-bold text-[#0d141b] dark:text-white mb-2">Search</label>
                                <div class="relative">
                                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#4c739a]">search</span>
                                    <input id="searchInput" type="text" placeholder="License plate, body number, engine number..." class="w-full bg-white dark:bg-slate-800 border border-[#cfdbe7] dark:border-slate-700 rounded-lg pl-10 pr-4 py-2.5 text-sm focus:ring-2 focus:ring-primary/20">
                                </div>
                            </div>

                            <!-- Brand Filter -->
                            <div>
                                <label class="block text-sm font-bold text-[#0d141b] dark:text-white mb-2">Brand</label>
                                <select id="brandFilter" class="w-full bg-white dark:bg-slate-800 border border-[#cfdbe7] dark:border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-primary/20">
                                    <option value="">All Brands</option>
                                </select>
                            </div>

                            <!-- Segment Filter -->
                            <div>
                                <label class="block text-sm font-bold text-[#0d141b] dark:text-white mb-2">Segment</label>
                                <select id="segmentFilter" class="w-full bg-white dark:bg-slate-800 border border-[#cfdbe7] dark:border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-primary/20">
                                    <option value="">All Segments</option>
                                    <!-- Passenger Vehicles -->
                                    <option value="A">A (Micro)</option>
                                    <option value="B">B (Small)</option>
                                    <option value="C">C (Compact)</option>
                                    <option value="D">D (Mid-Size)</option>
                                    <option value="E">E (Large)</option>
                                    <option value="F">F (Luxury)</option>
                                    <option value="J">J (SUV)</option>
                                    <option value="M">M (Multi-Purpose)</option>
                                    <!-- Commercial & Utility -->
                                    <option value="Light Commercial">Light Commercial</option>
                                    <option value="Heavy Commercial">Heavy Commercial</option>
                                    <option value="Bus">Bus (Coach)</option>
                                    <option value="Truck">Truck</option>
                                    <!-- Motorcycles -->
                                    <option value="Motobike - Scooter">Motobike - Scooter</option>
                                    <option value="Motobike - Cub">Motobike - Cub</option>
                                    <option value="Motobike - Sport">Motobike - Sport</option>
                                    <option value="Motobike - Cruiser">Motobike - Cruiser</option>
                                    <option value="Motobike - Touring">Motobike - Touring</option>
                                    <option value="Motobike - Dual-Sport">Motobike - Dual-Sport</option>
                                    <option value="Motobike - Chopper">Motobike - Chopper</option>
                                    <option value="Motobike - Naked">Motobike - Naked</option>
                                    <!-- Special -->
                                    <option value="Taxi">Taxi</option>
                                    <option value="Special Service">Special Service</option>
                                </select>
                            </div>

                            <!-- Seat Count Filter -->
                            <div>
                                <label class="block text-sm font-bold text-[#0d141b] dark:text-white mb-2">Seats</label>
                                <select id="seatFilter" class="w-full bg-white dark:bg-slate-800 border border-[#cfdbe7] dark:border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-primary/20">
                                    <option value="">All</option>
                                    <option value="2">2 Seats</option>
                                    <option value="4">4 Seats</option>
                                    <option value="5">5 Seats</option>
                                    <option value="7">7 Seats</option>
                                    <option value="9">9+ Seats</option>
                                </select>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-2">
                            <button id="resetFilters" class="flex items-center gap-2 px-4 py-2.5 bg-slate-100 dark:bg-slate-800 text-[#0d141b] dark:text-white text-sm font-bold rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                                <span class="material-symbols-outlined">refresh</span>
                                <span>Reset</span>
                            </button>
                            <button id="exportBtn" class="flex items-center gap-2 px-4 py-2.5 bg-primary text-white text-sm font-bold rounded-lg hover:brightness-110 transition-colors ml-auto">
                                <span class="material-symbols-outlined">download</span>
                                <span>Export List</span>
                            </button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50 dark:bg-slate-800/50 border-b border-[#e7edf3] dark:border-slate-800">
                                    <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-[#4c739a]">Vehicle</th>
                                    <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-[#4c739a]">Plate</th>
                                    <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-[#4c739a]">Owner</th>
                                    <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-[#4c739a]">Brand</th>
                                    <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-[#4c739a]">Type</th>
                                    <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-[#4c739a] text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vehicleTableBody" class="divide-y divide-[#e7edf3] dark:divide-slate-800">
                                <!-- Vehicles will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="hidden p-8 text-center">
                        <span class="material-symbols-outlined text-6xl text-[#4c739a] dark:text-slate-400 block mb-4">directions_car</span>
                        <p class="text-[#4c739a] dark:text-slate-400">No vehicles found</p>
                    </div>

                    <!-- Pagination -->
                    <div id="paginationContainer" class="p-6 border-t border-[#e7edf3] dark:border-slate-800 hidden">
                        <p class="text-sm text-[#4c739a] text-center">
                            Showing <span id="pageInfo">0-0</span> vehicles
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let vehicles = [];
        const API_BASE = '/api/vehicleinformation';
        const ITEMS_PER_PAGE = 50;
        let currentFiltered = [];

        // Load sidebar
        async function loadSidebar() {
            try {
                const response = await fetch('../templates/admin-sidebar.html');
                const html = await response.text();
                document.getElementById('sidebar-container').innerHTML = html;
                if (typeof initializeAdminSidebar === 'function') {
                    initializeAdminSidebar();
                }
            } catch (error) {
                console.error('Error loading sidebar:', error);
            }
        }

        loadSidebar();

        // Load vehicles
        async function loadVehicles() {
            try {
                const response = await fetch(`${API_BASE}/all`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    vehicles = data.data;
                    updateStats();
                    populateFilters();
                    renderVehicles(vehicles);
                } else {
                    showMessage('error', 'Failed to load vehicles');
                }
            } catch (error) {
                console.error('Error loading vehicles:', error);
                showMessage('error', 'An error occurred while loading vehicles');
            }
        }

        function updateStats() {
            document.getElementById('totalVehicles').textContent = vehicles.length;
            document.getElementById('activePolicies').textContent = vehicles.filter(v => v.policies && v.policies.length > 0).length;
            document.getElementById('pendingInspections').textContent = Math.floor(vehicles.length * 0.1);
        }

        function populateFilters() {
            const brands = [...new Set(vehicles.map(v => v.vehicleBrand).filter(Boolean))].sort();
            const brandSelect = document.getElementById('brandFilter');
            
            // Predefined popular brands
            const popularBrands = [
                'Audi', 'BMW', 'Chevrolet', 'Citroen', 'Dacia', 'Daihatsu',
                'Fiat', 'Ford', 'GAZ', 'Geely', 'Great Wall', 'Hafei',
                'Haima', 'Haval', 'Honda', 'Hyundai', 'Hyunhdai', 'Jaguar',
                'JAC', 'Jeep', 'Jianghuai', 'JMC', 'Kia', 'Lada', 'Lamborghini',
                'Land Rover', 'Lexus', 'Lifan', 'Lincoln', 'Maserati', 'Mazda',
                'Mercedes-Benz', 'MG', 'Mitsubishi', 'Morgan', 'Nissan', 'Opel',
                'Peugeot', 'Plymouth', 'Porsche', 'Renault', 'Rolls-Royce', 'Rover',
                'Saab', 'Samsung', 'Seat', 'Shanghai Volkswagen', 'Smart', 'Skoda',
                'Subaru', 'Suzuki', 'Tesla', 'Toyota', 'Volkswagen', 'Volvo',
                'Wuling', 'Xiali', 'Xingfu', 'Yanjing', 'Yunque', 'ZX'
            ];
            
            // Merge with actual brands from vehicles, prioritizing actual data
            const allBrands = [...new Set([...brands, ...popularBrands])].sort();
            
            allBrands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandSelect.appendChild(option);
            });
        }

        function renderVehicles(vehicleList) {
            const tbody = document.getElementById('vehicleTableBody');
            const emptyState = document.getElementById('emptyState');
            const pagination = document.getElementById('paginationContainer');

            if (vehicleList.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                pagination.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            pagination.classList.remove('hidden');

            const sliced = vehicleList.slice(0, ITEMS_PER_PAGE);
            tbody.innerHTML = sliced.map(vehicle => `
                <tr class="table-row-hover transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-primary/10 rounded flex items-center justify-center flex-shrink-0">
                                <span class="material-symbols-outlined text-primary">directions_car</span>
                            </div>
                            <div>
                                <p class="text-sm font-bold text-[#0d141b] dark:text-white">${vehicle.vehicleName}</p>
                                <p class="text-xs text-[#4c739a] dark:text-slate-400">${vehicle.vehicleType}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2.5 py-1 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded font-mono text-xs font-bold">
                            ${vehicle.vehicleNumber}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-[#0d141b] dark:text-white">${vehicle.customerName || 'N/A'}</span>
                            <span class="text-xs text-[#4c739a]">ID: ${vehicle.customerId || 'N/A'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-sm text-[#0d141b] dark:text-white font-medium">${vehicle.vehicleBrand}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-sm text-[#4c739a] dark:text-slate-400">${vehicle.vehicleSegment}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="window.location.href='VehicleDetailAdmin.html?id=${vehicle.vehicleId}'" 
                            class="inline-flex items-center justify-center w-8 h-8 rounded-full text-primary hover:bg-primary/10 transition-colors"
                            title="View Details">
                            <span class="material-symbols-outlined text-xl">info</span>
                        </button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('pageInfo').textContent = `1-${Math.min(ITEMS_PER_PAGE, vehicleList.length)}`;
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const brand = document.getElementById('brandFilter').value;
            const segment = document.getElementById('segmentFilter').value;
            const seats = document.getElementById('seatFilter').value;

            currentFiltered = vehicles.filter(v => {
                const matchSearch = !search || 
                    v.vehicleName.toLowerCase().includes(search) ||
                    v.vehicleNumber.toLowerCase().includes(search) ||
                    v.bodyNumber.toLowerCase().includes(search) ||
                    v.engineNumber.toLowerCase().includes(search) ||
                    (v.customerName && v.customerName.toLowerCase().includes(search));

                const matchBrand = !brand || v.vehicleBrand === brand;
                const matchSegment = !segment || v.vehicleSegment === segment;
                const matchSeats = !seats || v.seatCount == seats;

                return matchSearch && matchBrand && matchSegment && matchSeats;
            });

            renderVehicles(currentFiltered);
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('brandFilter').value = '';
            document.getElementById('segmentFilter').value = '';
            document.getElementById('seatFilter').value = '';
            applyFilters();
        }

        function exportList() {
            // Call the export API endpoint
            const token = localStorage.getItem('token');
            const url = '/api/vehicleinformation/export/excel';
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Export failed');
                }
                return response.blob();
            })
            .then(blob => {
                // Create a temporary URL for the blob
                const blobUrl = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = `Vehicles_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(blobUrl);
                
                showMessage('success', 'Vehicle list exported successfully');
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('error', 'Failed to export vehicle list');
            });
        }

        function showMessage(type, message) {
            if (type === 'success') {
                document.getElementById('successText').textContent = message;
                document.getElementById('successMessage').classList.remove('hidden');
                document.getElementById('errorMessage').classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('successMessage').classList.add('hidden');
                }, 5000);
            } else {
                document.getElementById('errorText').textContent = message;
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('successMessage').classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('errorMessage').classList.add('hidden');
                }, 5000);
            }
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('brandFilter').addEventListener('change', applyFilters);
        document.getElementById('segmentFilter').addEventListener('change', applyFilters);
        document.getElementById('seatFilter').addEventListener('change', applyFilters);
        document.getElementById('resetFilters').addEventListener('click', resetFilters);
        document.getElementById('exportBtn').addEventListener('click', exportList);

        // Initial load
        loadVehicles();
    </script>
    <script src="../js/admin-sidebar.js"></script>
</body>

</html>
