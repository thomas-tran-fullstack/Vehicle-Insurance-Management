<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Report a New Claim | AVIMS</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="../js/popMessage.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display min-h-screen">
    <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">
        <div id="header-container"></div>
        <main class="flex-1 max-w-[960px] mx-auto pb-8 px-4 sm:px-6 pt-8 w-full">
        <div class="mb-8">
            <h2 class="text-slate-900 dark:text-white text-3xl font-black leading-tight tracking-tight mb-2">Report a New Claim</h2>
            <p class="text-slate-500 dark:text-slate-400 text-base">Provide incident details below. Your claim will be processed quickly.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Form Column -->
            <div class="lg:col-span-2">
                <form id="claimForm" class="flex flex-col gap-6">
                    <!-- Step 1: Select Policy -->
                    <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-slate-200 dark:border-slate-800">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="size-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm">1</div>
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Select Your Policy</h3>
                        </div>
                        <select id="policySelect" required class="w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white">
                            <option value="">-- Choose an Active Policy --</option>
                        </select>
                        <div id="policyDetails" class="mt-4 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg hidden">
                            <p class="text-sm text-slate-600 dark:text-slate-400"><strong>Policy Period:</strong> <span id="policyPeriod"></span></p>
                        </div>
                    </div>

                    <!-- Step 2: Incident Details -->
                    <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-slate-200 dark:border-slate-800">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="size-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm">2</div>
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Incident Details</h3>
                        </div>
                        
                        <div class="flex flex-col gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-900 dark:text-white mb-2">Place of Accident *</label>
                                <input id="accidentPlace" type="text" required placeholder="e.g., District 1, HCMC" class="w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white" />
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-slate-900 dark:text-white mb-2">Date of Accident *</label>
                                <input id="accidentDate" type="date" required class="w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white" />
                                <p class="text-xs text-slate-500 mt-1">Must be within your policy period and not in the future</p>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-slate-900 dark:text-white mb-2">Description *</label>
                                <textarea id="description" required placeholder="Describe what happened..." rows="4" class="w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Supporting Documents -->
                    <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-slate-200 dark:border-slate-800">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="size-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm">3</div>
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Supporting Documents (Optional)</h3>
                        </div>

                        <div id="fileUploadArea" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-8 text-center cursor-pointer hover:border-primary hover:bg-primary/5 transition-colors">
                            <span class="material-symbols-outlined text-4xl text-slate-400 block mb-2">cloud_upload</span>
                            <p class="text-sm font-semibold text-slate-900 dark:text-white mb-1">Click to upload or drag files</p>
                            <p class="text-xs text-slate-500">Photos, reports, or supporting documents (Max 10MB)</p>
                            <input id="documentFile" type="file" accept="image/*,.pdf,.doc,.docx" style="display: none;" />
                        </div>
                        <div id="fileList" class="mt-4"></div>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex gap-4">
                        <button type="button" onclick="window.history.back()" class="flex-1 px-6 py-3 rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-900 dark:text-white font-bold transition-colors hover:bg-slate-300 dark:hover:bg-slate-700">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 px-6 py-3 rounded-lg bg-primary text-white font-bold transition-opacity hover:opacity-90">
                            Submit Claim
                        </button>
                    </div>
                </form>
            </div>

            <!-- Info Column -->
            <div class="lg:col-span-1">
                <div class="bg-primary/10 border border-primary/20 rounded-xl p-6 sticky top-6">
                    <h4 class="font-bold text-slate-900 dark:text-white mb-4">Claim Guidelines</h4>
                    <ul class="flex flex-col gap-3 text-sm text-slate-600 dark:text-slate-400">
                        <li class="flex gap-2">
                            <span class="text-primary font-bold">✓</span>
                            <span>Your policy must be ACTIVE</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="text-primary font-bold">✓</span>
                            <span>Accident must occur within policy dates</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="text-primary font-bold">✓</span>
                            <span>Provide accurate incident details</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="text-primary font-bold">✓</span>
                            <span>Supporting documents speed up processing</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <script>
        let userId = null;
        let activePolicies = [];
        let selectedPolicy = null;

        async function loadActivePolicies() {
            try {
                const userStr = localStorage.getItem('user') || sessionStorage.getItem('user');
                if (!userStr) {
                    console.log('User not authenticated');
                    return;
                }
                const user = JSON.parse(userStr);
                userId = user.userId;
                
                // Load active policies directly using userId
                const response = await fetch(`/api/policies/by-user/${userId}?status=ACTIVE`);
                const result = await response.json();
                if (result.success) {
                    activePolicies = result.data || [];
                    populatePolicySelect();
                } else {
                    console.error('Failed to load policies:', result.message);
                }
            } catch (error) {
                console.error('Error loading policies:', error);
            }
        }

        function populatePolicySelect() {
            const select = document.getElementById('policySelect');
            select.innerHTML = '<option value="">-- Choose an Active Policy --</option>';
            activePolicies.forEach(policy => {
                const option = document.createElement('option');
                option.value = policy.policyId;
                option.textContent = `Policy ${policy.policyNumber} - ${policy.vehicleName}`;
                select.appendChild(option);
            });
        }

        document.getElementById('policySelect').addEventListener('change', (e) => {
            const policyId = e.target.value;
            if (policyId) {
                selectedPolicy = activePolicies.find(p => p.policyId == policyId);
                const details = document.getElementById('policyDetails');
                if (selectedPolicy) {
                    document.getElementById('policyPeriod').textContent = `${selectedPolicy.policyStartDate} to ${selectedPolicy.policyEndDate}`;
                    details.classList.remove('hidden');
                    // Set max date to today and min to 5 days ago
                    const today = new Date();
                    const fiveDaysAgo = new Date(today.getTime() - 5 * 24 * 60 * 60 * 1000);
                    document.getElementById('accidentDate').max = today.toISOString().split('T')[0];
                    document.getElementById('accidentDate').min = fiveDaysAgo.toISOString().split('T')[0];
                }
            }
        });

        // File upload
        document.getElementById('fileUploadArea').addEventListener('click', () => {
            document.getElementById('documentFile').click();
        });

        document.getElementById('documentFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = `<div class="flex items-center gap-2 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                    <span class="material-symbols-outlined text-slate-400">attach_file</span>
                    <span class="text-sm text-slate-700 dark:text-slate-300 flex-1">${file.name}</span>
                    <button type="button" onclick="this.parentElement.remove()" class="text-red-500 font-bold">Remove</button>
                </div>`;
            }
        });

        // Form submission
        document.getElementById('claimForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedPolicy) {
                showPopMessage('Please select a policy', 'error');
                return;
            }

            const accidentDate = new Date(document.getElementById('accidentDate').value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (accidentDate > today) {
                showPopMessage('Accident date cannot be in the future', 'error');
                return;
            }

            const policyStart = new Date(selectedPolicy.policyStartDate);
            const policyEnd = new Date(selectedPolicy.policyEndDate);
            
            if (accidentDate < policyStart || accidentDate > policyEnd) {
                showPopMessage('Accident date must be within policy period', 'error');
                return;
            }

            // Format date as YYYY-MM-DD with time 00:00:00 to create a proper DateTime
            const dateValue = document.getElementById('accidentDate').value;
            const claimData = {
                PolicyId: parseInt(selectedPolicy.policyId),
                AccidentPlace: document.getElementById('accidentPlace').value,
                AccidentDate: dateValue + "T00:00:00",
                Description: document.getElementById('description').value,
                DocumentPath: null  // In real app, upload file first
            };

            try {
                console.log('Submitting claim:', claimData);
                const response = await fetch('/api/claims/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(claimData),
                    credentials: 'include'
                });

                console.log('Response status:', response.status, response.statusText);

                if (!response.ok) {
                    let errorMessage = 'Failed to submit claim';
                    try {
                        const responseText = await response.text();
                        console.log('Response body:', responseText);
                        if (responseText) {
                            const errorData = JSON.parse(responseText);
                            errorMessage = errorData.message || errorMessage;
                        }
                    } catch (e) {
                        console.error('Error parsing response:', e, 'status:', response.status);
                    }
                    console.error('Claim submission error:', errorMessage);
                    showPopMessage(errorMessage, 'error');
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    showPopMessage('Claim submitted successfully! Claim #' + result.data.claimNumber, 'success');
                    setTimeout(() => {
                        window.location.href = 'ClaimList.html';
                    }, 1500);
                } else {
                    showPopMessage('Error: ' + result.message, 'error');
                }
            } catch (error) {
                showPopMessage('Error submitting claim: ' + error.message, 'error');
            }
        });

        // Load data
        loadActivePolicies();
    </script>

    </main>
    </div>

    <!-- Footer from template -->
    <iframe id="footer-frame" src="../templates/footer.html"
        style="border: none; width: 100%; margin: 0; padding: 0; display: block; overflow: hidden;"
        frameborder="0"></iframe>

    <script>
        // Auto-adjust iframe heights
        function resizeIframe(iframe) {
            try {
                const height = iframe.contentWindow.document.documentElement.scrollHeight;
                iframe.style.height = height + 'px';
            } catch (err) {
                console.log('Cannot access iframe content');
            }
        }

        const footerFrame = document.getElementById('footer-frame');

        if (footerFrame) {
            footerFrame.onload = function () {
                resizeIframe(footerFrame);
            };
        }

        window.addEventListener('resize', function () {
            if (footerFrame) resizeIframe(footerFrame);
        });
    </script>

    <script>
        // Load header fragment
        fetch('../templates/header.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('header-container').innerHTML = html;
                const script = document.createElement('script');
                script.src = '../js/header.js';
                script.onload = () => {
                    let retries = 0;
                    const checkAndInitialize = () => {
                        retries++;
                        if (window.headerScriptLoaded && typeof window.initializeHeader === 'function') {
                            window.initializeHeader();
                        } else if (retries < 10) {
                            setTimeout(checkAndInitialize, 100);
                        }
                    };
                    checkAndInitialize();
                };
                document.head.appendChild(script);
            });
    </script>

    <script src="../js/pageLoader.js"></script>
</body>

</html>
        