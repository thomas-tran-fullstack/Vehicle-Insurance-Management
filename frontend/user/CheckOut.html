<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - AVIMS</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" />
  <style>body{font-family:Inter,sans-serif;}</style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
  <div id="header-container"></div>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <div class="mb-6">
      <h1 class="text-3xl font-extrabold">Checkout</h1>
      <p class="text-slate-500">Complete payment to activate your policy.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="lg:col-span-2 bg-white border border-slate-200 rounded-xl p-6">
        <h2 class="text-lg font-bold mb-4">Payment Details</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium mb-1">Payment Method</label>
            <select id="paymentMethod" class="w-full rounded-lg border-slate-300 h-11">
              <option value="ONLINE">Online</option>
              <option value="CARD">Card</option>
              <option value="BANK_TRANSFER">Bank Transfer</option>
              <option value="CASH">Cash</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Transaction Reference</label>
            <input id="transactionRef" class="w-full rounded-lg border-slate-300 h-11" placeholder="Auto-generated if blank" />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <label class="block text-sm font-medium mb-1">Cardholder Name</label>
            <input id="cardholderName" class="w-full rounded-lg border-slate-300 h-11" placeholder="Required for CARD" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Card Number</label>
            <input id="cardNumber" class="w-full rounded-lg border-slate-300 h-11" placeholder="Required for CARD" />
          </div>
        </div>

        <button id="payNowBtn" class="px-6 py-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700">Pay Now</button>
        <button id="backBtn" class="ml-2 px-6 py-3 rounded-lg border border-slate-300 font-bold hover:bg-slate-100">Back</button>
      </section>

      <aside class="bg-white border border-slate-200 rounded-xl p-6">
        <h2 class="text-lg font-bold mb-4">Order Summary</h2>
        <div class="space-y-2 text-sm">
          <div><span class="text-slate-500">Policy #:</span> <b id="policyNumber">-</b></div>
          <div><span class="text-slate-500">Vehicle:</span> <b id="vehicleName">-</b></div>
          <div><span class="text-slate-500">Policy Type:</span> <b id="policyType">-</b></div>
          <div><span class="text-slate-500">End Date:</span> <b id="policyEndDate">-</b></div>
          <div><span class="text-slate-500">Payment Due:</span> <b id="paymentDueDate">-</b></div>
        </div>
        <div class="mt-5 pt-4 border-t border-slate-200">
          <div class="flex items-center justify-between">
            <span class="font-semibold">Total</span>
            <span id="totalAmount" class="text-xl font-extrabold text-blue-600">$0.00</span>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <iframe id="footer-frame" src="../templates/footer.html" style="border:none;width:100%;display:block;"></iframe>

  <script>
    fetch('../templates/header.html').then(r=>r.text()).then(html=>{
      document.getElementById('header-container').innerHTML = html;
      const script = document.createElement('script');
      script.src = '../js/header.js';
      document.head.appendChild(script);
    });

    const state = { billId: 0, bill: null, policy: null };

    function getSessionUser() {
      const raw = sessionStorage.getItem('user') || localStorage.getItem('user');
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function fmtDate(value) {
      if (!value) return '-';
      return new Date(value).toLocaleDateString();
    }

    function fmtMoney(value) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(Number(value || 0));
    }

    function validatePaymentForm() {
      const method = document.getElementById('paymentMethod').value;
      if (method === 'CARD') {
        const name = document.getElementById('cardholderName').value.trim();
        const card = document.getElementById('cardNumber').value.trim();
        if (!name || !card) {
          alert('Cardholder name and card number are required for CARD payment.');
          return false;
        }
      }
      return true;
    }

    async function loadBill() {
      const params = new URLSearchParams(window.location.search);
      state.billId = Number(params.get('billId') || 0);
      const policyId = Number(params.get('policyId') || 0);

      if (!state.billId && policyId) {
        const billsRes = await fetch(`/api/BillingPayment?policyId=${policyId}`);
        const billsData = await billsRes.json();
        const unpaid = (billsData.data || []).find(b => (b.status || '').toUpperCase() !== 'PAID');
        if (unpaid) {
          state.billId = unpaid.billId;
        }
      }

      if (!state.billId) {
        alert('Missing billId.');
        window.location.href = './BillingList.html';
        return;
      }

      const response = await fetch(`/api/BillingPayment/${state.billId}`);
      const result = await response.json();
      if (!result.success) {
        alert(result.message || 'Unable to load bill.');
        window.location.href = './BillingList.html';
        return;
      }

      state.bill = result.data;
      document.getElementById('policyNumber').textContent = state.bill.policyNumber || '-';
      document.getElementById('vehicleName').textContent = state.bill.vehicleName || '-';
      document.getElementById('policyType').textContent = state.bill.billType || '-';
      document.getElementById('paymentDueDate').textContent = fmtDate(state.bill.dueDate);
      document.getElementById('totalAmount').textContent = fmtMoney(state.bill.amount);

      if (state.bill.policyId) {
        const policyRes = await fetch(`/api/PolicyManagement/${state.bill.policyId}`);
        const policyData = await policyRes.json();
        if (policyData.success) {
          state.policy = policyData.data;
          document.getElementById('policyEndDate').textContent = fmtDate(state.policy.policyEndDate);
        }
      }

      if ((state.bill.status || '').toUpperCase() === 'PAID') {
        document.getElementById('payNowBtn').disabled = true;
        document.getElementById('payNowBtn').classList.add('opacity-50', 'cursor-not-allowed');
        alert('This bill is already paid.');
      }
    }

    async function payNow() {
      if (!validatePaymentForm()) return;
      const user = getSessionUser();
      if (!user) {
        window.location.href = './Login.html';
        return;
      }

      const method = document.getElementById('paymentMethod').value;
      const ref = document.getElementById('transactionRef').value.trim() || `PAY-${Date.now()}`;

      const createRes = await fetch(`/api/BillingPayment/${state.billId}/payments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          method,
          transactionRef: ref,
          actorUserId: user.userId
        })
      });

      const createData = await createRes.json();
      if (!createData.success) {
        alert(createData.message || 'Unable to create payment.');
        return;
      }

      const paymentId = createData.data?.billPaymentId;
      const confirmRes = await fetch(`/api/BillingPayment/${state.billId}/payments/${paymentId}/confirm`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          success: true,
          actorUserId: user.userId
        })
      });

      const confirmData = await confirmRes.json();
      if (!confirmData.success) {
        alert(confirmData.message || 'Payment failed.');
        return;
      }

      alert(confirmData.message || 'Payment successful.');
      window.location.href = './BillingList.html';
    }

    document.getElementById('payNowBtn').addEventListener('click', payNow);
    document.getElementById('backBtn').addEventListener('click', () => {
      window.location.href = './InsurancePoliciesList.html';
    });

    loadBill();
  </script>
  <script src="../js/pageLoader.js"></script>
</body>
</html>
