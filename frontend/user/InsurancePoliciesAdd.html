<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Purchase Policy - AVIMS</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700&amp;display=swap"
        rel="stylesheet" />
    <script src="../js/popMessage.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark min-h-screen font-display text-slate-900 dark:text-slate-100">
    <div id="header-container"></div>
    <main class="max-w-[1200px] mx-auto px-4 lg:px-10 py-8">
        <div class="flex flex-col lg:flex-row items-start justify-between gap-6 mb-8">
            <div>
                <h1 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight mb-2">Purchase Policy</h1>
                <p class="text-slate-600 dark:text-slate-400 text-lg">Finalize your approved estimate and activate
                    coverage.</p>
            </div>
            <button onclick="window.location.href='EstimateList.html'"
                class="flex items-center gap-2 px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 text-sm font-bold hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                <span class="material-symbols-outlined text-sm">arrow_back</span>
                Back to Estimates
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-800">
                        <h2 class="text-xl font-bold text-slate-900 dark:text-white">Estimate Summary</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1" id="estimateStatusText">Loading estimate...</p>
                    </div>
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-xs uppercase tracking-wider text-slate-400">Estimate Number</p>
                            <p id="estimateNumber" class="font-semibold text-slate-900 dark:text-white">-</p>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-wider text-slate-400">Insurance Type</p>
                            <p id="estimateType" class="font-semibold text-slate-900 dark:text-white">-</p>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-wider text-slate-400">Vehicle</p>
                            <p id="estimateVehicle" class="font-semibold text-slate-900 dark:text-white">-</p>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-wider text-slate-400">Valid Until</p>
                            <p id="estimateValidUntil" class="font-semibold text-slate-900 dark:text-white">-</p>
                        </div>
                    </div>
                </div>

                <form id="policyForm"
                    class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-800">
                        <h2 class="text-xl font-bold text-slate-900 dark:text-white">Policy Details</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Complete required information to
                            activate the policy.</p>
                    </div>
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-semibold text-slate-700 dark:text-slate-300">Start Date</label>
                            <input id="policyStartDate" type="date"
                                class="rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:border-primary focus:ring-primary h-12" />
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-semibold text-slate-700 dark:text-slate-300">Duration
                                (months)</label>
                            <input id="policyDuration" type="number" min="1" value="12"
                                class="rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:border-primary focus:ring-primary h-12" />
                        </div>
                        <div class="md:col-span-2 flex flex-col gap-2">
                            <label class="text-sm font-semibold text-slate-700 dark:text-slate-300">Address Proof
                                (PDF/JPG/PNG, max 5MB)</label>
                            <input id="addressProof" type="file" accept=".pdf,.jpg,.jpeg,.png"
                                class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary/90" />
                        </div>
                    </div>
                    <div class="px-6 pb-6 pt-2 flex justify-end gap-3">
                        <button type="button" id="createPolicyBtn"
                            class="px-8 py-3 rounded-lg bg-primary text-white font-bold hover:bg-primary/90 transition-all flex items-center gap-2">
                            Create Policy
                            <span class="material-symbols-outlined text-sm">verified</span>
                        </button>
                    </div>
                </form>

                <div id="paymentActions"
                    class="hidden bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm p-6">
                    <h3 class="text-lg font-bold mb-3">Payment</h3>
                    <p id="paymentInfo" class="text-sm text-slate-500 dark:text-slate-400 mb-4">Policy created.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-semibold text-slate-700 dark:text-slate-300">Payment Method</label>
                            <select id="paymentMethod" class="rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 h-10">
                                <option value="ONLINE">Online</option>
                                <option value="CARD">Card</option>
                                <option value="BANK_TRANSFER">Bank Transfer</option>
                                <option value="CASH">Cash</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-semibold text-slate-700 dark:text-slate-300">Transaction Ref</label>
                            <input id="transactionRef" class="rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 h-10 px-3" placeholder="Optional reference" />
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button type="button" id="payNowBtn"
                            class="px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm font-bold hover:bg-emerald-700">
                            Pay Now
                        </button>
                    </div>
                </div>
            </div>

            <aside class="space-y-6">
                <div class="bg-primary text-white p-6 rounded-xl shadow-lg shadow-primary/20">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined">payments</span>
                        Premium Summary
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="opacity-80">Estimated Premium</span>
                            <span id="estimatePremium" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="opacity-80">Duration</span>
                            <span id="estimateDuration" class="font-semibold">12 months</span>
                        </div>
                        <div class="flex justify-between text-sm border-t border-white/20 pt-3">
                            <span class="opacity-80">Status</span>
                            <span id="estimateStatus" class="font-semibold">APPROVED</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800">
                    <h4 class="font-bold text-sm mb-4">Next Steps</h4>
                    <ul class="space-y-2 text-xs text-slate-500 dark:text-slate-400">
                        <li>Upload address proof to validate policy ownership.</li>
                        <li>Policy will be created in Waiting Payment status.</li>
                        <li>You can activate it once payment is recorded.</li>
                    </ul>
                </div>
            </aside>
        </div>
    </main>

    <iframe id="footer-frame" src="../templates/footer.html"
        style="border: none; width: 100%; margin: 0; padding: 0; display: block; overflow: hidden;"
        frameborder="0"></iframe>

    <script>
        fetch('../templates/header.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('header-container').innerHTML = html;
                setTimeout(() => {
                    if (window.initializeHeader) {
                        window.initializeHeader();
                    }
                }, 100);
            })
            .catch(error => console.error('Error loading header:', error));
    </script>
    <script>
        const policyState = {
            estimateId: null,
            estimate: null,
            policyId: null
        };

        function getSessionUser() {
            const sessionStr = sessionStorage.getItem('user');
            const localStr = localStorage.getItem('user');
            const userStr = sessionStr || localStr;
            if (!userStr) return null;
            try {
                return JSON.parse(userStr);
            } catch {
                return null;
            }
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(Number(value || 0));
        }

        function formatDate(value) {
            if (!value) return '-';
            return new Date(value).toLocaleDateString();
        }

        async function loadEstimate() {
            const params = new URLSearchParams(window.location.search);
            const estimateId = Number(params.get('estimateId') || 0);
            if (!estimateId) {
                document.getElementById('estimateStatusText').textContent = 'Estimate ID is missing.';
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('policyStartDate').value = today;

            policyState.estimateId = estimateId;
            const response = await fetch(`/api/InsuranceEstimate/${estimateId}`);
            const data = await response.json();
            if (!data.success) {
                document.getElementById('estimateStatusText').textContent = data.message || 'Unable to load estimate.';
                return;
            }

            policyState.estimate = data.data;
            document.getElementById('estimateStatusText').textContent = `Estimate status: ${data.data.status || 'N/A'}`;
            document.getElementById('estimateNumber').textContent = data.data.estimateNumber || data.data.estimateId;
            document.getElementById('estimateType').textContent = data.data.policyTypeSnapshot || '-';
            document.getElementById('estimateVehicle').textContent = `${data.data.vehicleName || '-'} (${data.data.vehicleModel || '-'})`;
            document.getElementById('estimateValidUntil').textContent = formatDate(data.data.validUntil);
            document.getElementById('estimatePremium').textContent = formatCurrency(data.data.estimatedPremium);
            document.getElementById('estimateStatus').textContent = data.data.status || '-';
            document.getElementById('estimateDuration').textContent = `${document.getElementById('policyDuration').value || 12} months`;

            if ((data.data.status || '').toUpperCase() !== 'APPROVED') {
                document.getElementById('createPolicyBtn').disabled = true;
                document.getElementById('createPolicyBtn').classList.add('opacity-60', 'cursor-not-allowed');
            }

            if (data.data.validUntil && new Date(data.data.validUntil).getTime() < Date.now()) {
                document.getElementById('estimateStatusText').textContent = 'Estimate expired. Please request a new quote.';
                document.getElementById('createPolicyBtn').disabled = true;
                document.getElementById('createPolicyBtn').classList.add('opacity-60', 'cursor-not-allowed');
            }
        }

        document.getElementById('policyDuration').addEventListener('input', () => {
            document.getElementById('estimateDuration').textContent = `${document.getElementById('policyDuration').value || 12} months`;
        });

        document.getElementById('createPolicyBtn').addEventListener('click', async () => {
            if (!policyState.estimateId) {
                alert('Estimate is missing.');
                return;
            }

            const user = getSessionUser();
            if (!user) {
                window.location.href = './Login.html';
                return;
            }

            const formData = new FormData();
            formData.append('estimateId', policyState.estimateId);
            formData.append('policyStartDate', document.getElementById('policyStartDate').value);
            formData.append('durationMonths', document.getElementById('policyDuration').value || '12');
            const file = document.getElementById('addressProof').files[0];
            if (!file) {
                alert('Please upload address proof.');
                return;
            }
            formData.append('addressProof', file);
            formData.append('actorUserId', user.userId);

            const response = await fetch('/api/policies/from-estimate', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                showPopMessage('Error: ' + (errorText || response.statusText), 'error');
                return;
            }

            let data;
            try {
                const text = await response.text();
                if (!text) {
                    showPopMessage('Server returned empty response', 'error');
                    return;
                }
                data = JSON.parse(text);
            } catch (e) {
                showPopMessage('Invalid response from server: ' + e.message, 'error');
                return;
            }

            if (!data.success) {
                showPopMessage('Error: ' + (data.message || 'Unable to create policy.'), 'error');
                return;
            }

            policyState.policyId = data.data.policyId;
            const dueDate = formatDate(data.data.paymentDueDate);
            document.getElementById('estimateStatus').textContent = data.data.status || 'WAITING_PAYMENT';
            document.getElementById('estimateStatusText').textContent = `Policy #${data.data.policyNumber} created. Complete payment before ${dueDate}.`;
            document.getElementById('paymentInfo').textContent = `Policy #${data.data.policyNumber} is WAITING_PAYMENT. Due date: ${dueDate}.`;
            document.getElementById('paymentActions').classList.remove('hidden');
            showPopMessage(`Policy created successfully.\nStatus: ${data.data.status}\nDue: ${dueDate}`, 'success');
        });

        async function submitPayment() {
            if (!policyState.policyId) {
                showPopMessage('Please create policy first.', 'error');
                return;
            }

            const user = getSessionUser();
            const method = document.getElementById('paymentMethod').value || 'ONLINE';
            const refInput = document.getElementById('transactionRef').value.trim();
            const response = await fetch(`/api/policies/${policyState.policyId}/payment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    success: true,
                    method,
                    transactionRef: refInput || `PAY-${Date.now()}`,
                    actorUserId: user?.userId || null
                })
            });
            const data = await response.json();
            if (!data.success) {
                alert(data.message || 'Payment update failed.');
                return;
            }

            alert(data.message || 'Updated.');
            window.location.href = './InsurancePoliciesList.html';
        }

        document.getElementById('payNowBtn').addEventListener('click', submitPayment);

        loadEstimate();
    </script>
    <script src="../js/pageLoader.js"></script>
</body>

</html>
