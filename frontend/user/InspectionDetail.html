<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Inspection Details - AVIMS</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="../js/popMessage.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark min-h-screen">
    <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">
        <div id="header-container"></div>
        <main class="flex-1 max-w-[900px] mx-auto px-4 py-8 pt-8 w-full">
        <button onclick="window.history.back()" class="flex items-center gap-2 text-primary font-semibold mb-6 hover:opacity-70">
            <span class="material-symbols-outlined">arrow_back</span>
            Back to Inspections
        </button>

        <div id="loadingMsg" class="text-center py-12 text-slate-500">
            <span class="material-symbols-outlined text-4xl opacity-50 block mb-4 animate-spin">hourglass_empty</span>
            <p>Loading inspection details...</p>
        </div>

        <div id="contentArea" class="hidden">
            <!-- Header Card -->
            <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-slate-200 dark:border-slate-800 mb-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Inspection <span id="inspectionId"></span></h1>
                        <p id="vehicleName" class="text-slate-600 dark:text-slate-400"></p>
                    </div>
                    <span id="statusBadge" class="px-4 py-2 rounded-full text-sm font-semibold"></span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4 border-t border-slate-200 dark:border-slate-800">
                    <div>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-1">Scheduled Date</p>
                        <p id="scheduledDate" class="font-semibold text-slate-900 dark:text-white"></p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-1">Inspector</p>
                        <p id="inspectorName" class="font-semibold text-slate-900 dark:text-white"></p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-1">Location</p>
                        <p id="location" class="font-semibold text-slate-900 dark:text-white"></p>
                    </div>
                </div>
            </div>

            <!-- Vehicle Information -->
            <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-slate-200 dark:border-slate-800 mb-6">
                <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Vehicle Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-1">Vehicle Name</p>
                        <p id="vehicleInfo" class="font-semibold text-slate-900 dark:text-white"></p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-1">Owner</p>
                        <p id="ownerInfo" class="font-semibold text-slate-900 dark:text-white"></p>
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-slate-200 dark:border-slate-800 mb-6">
                <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-6">Inspection Timeline</h2>
                <div id="timeline" class="space-y-6"></div>
            </div>

            <!-- Inspection Report (if completed) -->
            <div id="reportSection" class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-slate-200 dark:border-slate-800 mb-6 hidden">
                <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Inspection Report</h2>
                <div class="space-y-4">
                    <div>
                        <p class="text-sm font-semibold text-slate-900 dark:text-white mb-2">Overall Assessment</p>
                        <p id="assessment" class="text-slate-600 dark:text-slate-400 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg"></p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-900 dark:text-white mb-2">Status Confirmation</p>
                        <p id="confirmation" class="text-slate-600 dark:text-slate-400"></p>
                    </div>
                    <div id="documentsSection">
                        <p class="text-sm font-semibold text-slate-900 dark:text-white mb-2">Supporting Documents</p>
                        <a id="docLink" href="#" class="text-primary font-semibold hover:underline flex items-center gap-2">
                            <span class="material-symbols-outlined">download</span>
                            <span>View Report Documents</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Verification Status (if verified) -->
            <div id="verificationSection" class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-slate-200 dark:border-slate-800 mb-6 hidden">
                <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Verification Status</h2>
                <div class="space-y-3">
                    <p class="text-sm"><strong>Verified By:</strong> <span id="verifiedBy" class="text-slate-600 dark:text-slate-400"></span></p>
                    <p class="text-sm"><strong>Verification Date:</strong> <span id="verifiedDate" class="text-slate-600 dark:text-slate-400"></span></p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4">
                <button onclick="window.history.back()" class="flex-1 px-6 py-3 bg-slate-200 dark:bg-slate-800 text-slate-900 dark:text-white font-bold rounded-lg hover:opacity-90">
                    Back
                </button>
                <button id="downloadBtn" onclick="downloadReport()" class="flex-1 px-6 py-3 bg-primary text-white font-bold rounded-lg hover:opacity-90 flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">download</span>
                    <span>Download Report</span>
                </button>
            </div>
        </div>
    </main>

    <script>
        let inspection = null;

        async function loadInspection() {
            const params = new URLSearchParams(window.location.search);
            const inspectionId = params.get('id');

            if (!inspectionId) {
                document.getElementById('loadingMsg').innerHTML = '<p class="text-red-500">No inspection ID provided</p>';
                return;
            }

            try {
                const response = await fetch(`/api/inspections/${inspectionId}`);
                const result = await response.json();

                if (result.success) {
                    inspection = result.data;
                    displayInspection();
                } else {
                    document.getElementById('loadingMsg').innerHTML = '<p class="text-red-500">Inspection not found</p>';
                }
            } catch (error) {
                console.error('Error loading inspection:', error);
                document.getElementById('loadingMsg').innerHTML = '<p class="text-red-500">Error loading inspection details</p>';
            }
        }

        function displayInspection() {
            document.getElementById('loadingMsg').classList.add('hidden');
            document.getElementById('contentArea').classList.remove('hidden');

            // Header
            document.getElementById('inspectionId').textContent = '#INS-' + inspection.inspectionId;
            document.getElementById('vehicleName').textContent = inspection.vehicle?.vehicleName || 'N/A';
            
            const statusClasses = {
                'SCHEDULED': 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300',
                'IN_PROGRESS': 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300',
                'COMPLETED': 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300',
                'VERIFIED': 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300'
            };
            const statusLabels = {
                'SCHEDULED': 'Scheduled',
                'IN_PROGRESS': 'In Progress',
                'COMPLETED': 'Completed',
                'VERIFIED': 'Verified'
            };
            
            const badge = document.getElementById('statusBadge');
            badge.className = 'px-4 py-2 rounded-full text-sm font-semibold ' + (statusClasses[inspection.status] || statusClasses['SCHEDULED']);
            badge.textContent = statusLabels[inspection.status] || inspection.status;

            document.getElementById('scheduledDate').textContent = formatDate(inspection.scheduledDate);
            document.getElementById('inspectorName').textContent = inspection.staff?.fullName || 'Not Assigned';
            document.getElementById('location').textContent = inspection.inspectionLocation || 'TBD';

            // Vehicle Info
            document.getElementById('vehicleInfo').textContent = inspection.vehicle?.vehicleName + ' (' + inspection.vehicle?.vehicleNumber + ')';
            document.getElementById('ownerInfo').textContent = inspection.vehicle?.customerName || 'N/A';

            // Timeline
            buildTimeline();

            // Report Section (if completed)
            if (inspection.status !== 'SCHEDULED' && inspection.status !== 'NEW') {
                document.getElementById('reportSection').classList.remove('hidden');
                document.getElementById('assessment').textContent = inspection.overallAssessment || 'No assessment provided';
                const confirmed = inspection.confirmedCorrect;
                document.getElementById('confirmation').innerHTML = `
                    <span class="${confirmed ? 'text-green-600' : 'text-red-600'} font-semibold">
                        ${confirmed ? '✓ Status Confirmed Correct' : '✗ Status Discrepancies Found'}
                    </span>
                `;
            }

            // Verification Section (if verified)
            if (inspection.status === 'VERIFIED') {
                document.getElementById('verificationSection').classList.remove('hidden');
                document.getElementById('verifiedBy').textContent = inspection.verifiedByStaff?.fullName || 'N/A';
                document.getElementById('verifiedDate').textContent = formatDate(inspection.verifiedAt);
            }
        }

        function buildTimeline() {
            const timeline = document.getElementById('timeline');
            const statuses = [
                { label: 'Scheduled', icon: 'event', date: inspection.scheduledDate, done: true },
                { label: 'In Progress', icon: 'sync', date: null, done: inspection.status !== 'SCHEDULED' },
                { label: 'Completed', icon: 'done_all', date: inspection.completedDate, done: inspection.status === 'COMPLETED' || inspection.status === 'VERIFIED' },
                { label: 'Verified', icon: 'verified', date: inspection.verifiedAt, done: inspection.status === 'VERIFIED' }
            ];

            timeline.innerHTML = statuses.map((status, idx) => `
                <div class="flex gap-4">
                    <div class="flex flex-col items-center">
                        <div class="size-10 rounded-full flex items-center justify-center text-white font-bold ${status.done ? 'bg-primary' : 'bg-slate-300 dark:bg-slate-700'}">
                            <span class="material-symbols-outlined text-lg">${status.icon}</span>
                        </div>
                        ${idx < statuses.length - 1 ? '<div class="w-1 h-8 bg-slate-200 dark:bg-slate-700 mt-2"></div>' : ''}
                    </div>
                    <div class="pb-8">
                        <p class="font-semibold text-slate-900 dark:text-white">${status.label}</p>
                        ${status.date ? '<p class="text-sm text-slate-500 dark:text-slate-400">' + formatDate(status.date) + '</p>' : ''}
                    </div>
                </div>
            `).join('');
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Pending';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function downloadReport() {
            if (inspection.documentPath) {
                window.open(inspection.documentPath, '_blank');
            } else {
                showPopMessage('No document available for download', 'error');
            }
        }

        loadInspection();
    </script>

    </main>
    </div>

    <!-- Footer from template -->
    <iframe id="footer-frame" src="../templates/footer.html"
        style="border: none; width: 100%; margin: 0; padding: 0; display: block; overflow: hidden;"
        frameborder="0"></iframe>

    <script>
        // Auto-adjust iframe heights
        function resizeIframe(iframe) {
            try {
                const height = iframe.contentWindow.document.documentElement.scrollHeight;
                iframe.style.height = height + 'px';
            } catch (err) {
                console.log('Cannot access iframe content');
            }
        }

        const footerFrame = document.getElementById('footer-frame');

        if (footerFrame) {
            footerFrame.onload = function () {
                resizeIframe(footerFrame);
            };
        }

        window.addEventListener('resize', function () {
            if (footerFrame) resizeIframe(footerFrame);
        });
    </script>

    <script>
        // Load header fragment
        fetch('../templates/header.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('header-container').innerHTML = html;
                const script = document.createElement('script');
                script.src = '../js/header.js';
                script.onload = () => {
                    let retries = 0;
                    const checkAndInitialize = () => {
                        retries++;
                        if (window.headerScriptLoaded && typeof window.initializeHeader === 'function') {
                            window.initializeHeader();
                        } else if (retries < 10) {
                            setTimeout(checkAndInitialize, 100);
                        }
                    };
                    checkAndInitialize();
                };
                document.head.appendChild(script);
            });
    </script>

    <script src="../js/pageLoader.js"></script>
</body>

</html>
        