<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Inspection History - AVIMS</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-200 min-h-screen">
    <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">
        <div id="header-container"></div>
        <main class="flex-1 max-w-[1200px] mx-auto px-4 lg:px-10 py-8 pt-8 w-full">
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8">
            <div class="flex flex-col gap-1">
                <h1 class="text-slate-900 dark:text-white text-4xl font-black leading-tight tracking-tight">Inspection History</h1>
                <p class="text-slate-500 dark:text-slate-400 text-lg font-normal">Track all your vehicle inspections</p>
            </div>
        </div>

        <div class="bg-white dark:bg-slate-900 rounded-xl p-4 mb-6 shadow-sm border border-slate-100 dark:border-slate-800 flex flex-col md:flex-row gap-4 items-center justify-between">
            <div class="relative w-full md:w-96">
                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
                <input id="searchInput" class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-800 border-none rounded-lg text-sm focus:ring-2 focus:ring-primary/20" placeholder="Search by ID or Vehicle..." />
            </div>
            <div class="flex items-center gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                <button onclick="filterByStatus('')" class="px-4 py-2 bg-primary/10 text-primary text-sm font-semibold rounded-full whitespace-nowrap">All</button>
                <button onclick="filterByStatus('SCHEDULED')" class="px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 text-sm font-medium rounded-full whitespace-nowrap">Scheduled</button>
                <button onclick="filterByStatus('IN_PROGRESS')" class="px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 text-sm font-medium rounded-full whitespace-nowrap">In Progress</button>
                <button onclick="filterByStatus('COMPLETED')" class="px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 text-sm font-medium rounded-full whitespace-nowrap">Completed</button>
                <button onclick="filterByStatus('VERIFIED')" class="px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 text-sm font-medium rounded-full whitespace-nowrap">Verified</button>
            </div>
        </div>

        <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-800">
                            <th class="px-6 py-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Inspection ID</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Vehicle</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Appointment Date</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Inspector</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="inspectionsTable" class="divide-y divide-slate-100 dark:divide-slate-800">
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                            <td colspan="6" class="px-6 py-8 text-center text-slate-500">Loading inspections...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="noResults" class="text-center py-12 text-slate-500 hidden">
            <span class="material-symbols-outlined text-5xl opacity-50 block mb-4">assignment_ind</span>
            <p>No inspections found</p>
        </div>
    </main>

    <script>
        let userId = null;
        let allInspections = [];
        let currentFilter = '';

        async function loadInspections() {
            try {
                const userStr = localStorage.getItem('user') || sessionStorage.getItem('user');
                if (!userStr) {
                    console.log('User not authenticated');
                    return;
                }
                const user = JSON.parse(userStr);
                userId = user.userId;
                
                // Load inspections directly using userId
                const response = await fetch(`/api/inspections/by-user/${userId}`);
                const result = response.ok ? await response.json() : { success: false };
                if (result.success) {
                    allInspections = result.data || [];
                    displayInspections(allInspections);
                } else {
                    displayInspections([]);
                }
            } catch (error) {
                console.error('Error loading inspections:', error);
                displayInspections([]);
            }
        }

        function displayInspections(inspections) {
            const table = document.getElementById('inspectionsTable');
            const noResults = document.getElementById('noResults');

            if (inspections.length === 0) {
                table.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500">No inspections found</td></tr>';
                noResults.classList.remove('hidden');
                return;
            }

            noResults.classList.add('hidden');
            table.innerHTML = inspections.map(inspection => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                    <td class="px-6 py-4"><span class="font-semibold text-slate-900 dark:text-white">INS-${inspection.inspectionId}</span></td>
                    <td class="px-6 py-4">${inspection.vehicleName || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">${formatDate(inspection.scheduledDate)}</td>
                    <td class="px-6 py-4 text-sm">${inspection.staffName || 'Not Assigned'}</td>
                    <td class="px-6 py-4"><span class="${getStatusBadgeClass(inspection.status)}">${getStatusLabel(inspection.status)}</span></td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="viewDetail(${inspection.inspectionId})" class="text-primary font-semibold text-sm hover:underline">View Details â†’</button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'SCHEDULED': 'px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300',
                'IN_PROGRESS': 'px-3 py-1 rounded-full text-xs font-semibold bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300',
                'COMPLETED': 'px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300',
                'VERIFIED': 'px-3 py-1 rounded-full text-xs font-semibold bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300'
            };
            return classes[status] || classes['SCHEDULED'];
        }

        function getStatusLabel(status) {
            const labels = {
                'SCHEDULED': 'Scheduled',
                'IN_PROGRESS': 'In Progress',
                'COMPLETED': 'Completed',
                'VERIFIED': 'Verified',
                'NEW': 'New'
            };
            return labels[status] || status;
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            return new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function filterByStatus(status) {
            currentFilter = status;
            const filtered = status ? allInspections.filter(i => i.status === status) : allInspections;
            displayInspections(filtered);
        }

        function viewDetail(inspectionId) {
            window.location.href = `InspectionDetail.html?id=${inspectionId}`;
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = allInspections.filter(i => 
                i.inspectionId.toString().includes(query) || 
                (i.vehicleName || '').toLowerCase().includes(query)
            );
            displayInspections(filtered);
        });

        loadInspections();
    </script>

    </main>
    </div>

    <!-- Footer from template -->
    <iframe id="footer-frame" src="../templates/footer.html"
        style="border: none; width: 100%; margin: 0; padding: 0; display: block; overflow: hidden;"
        frameborder="0"></iframe>

    <script>
        // Auto-adjust iframe heights
        function resizeIframe(iframe) {
            try {
                const height = iframe.contentWindow.document.documentElement.scrollHeight;
                iframe.style.height = height + 'px';
            } catch (err) {
                console.log('Cannot access iframe content');
            }
        }

        const footerFrame = document.getElementById('footer-frame');

        if (footerFrame) {
            footerFrame.onload = function () {
                resizeIframe(footerFrame);
            };
        }

        window.addEventListener('resize', function () {
            if (footerFrame) resizeIframe(footerFrame);
        });
    </script>

    <script>
        // Load header fragment
        fetch('../templates/header.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('header-container').innerHTML = html;
                const script = document.createElement('script');
                script.src = '../js/header.js';
                script.onload = () => {
                    let retries = 0;
                    const checkAndInitialize = () => {
                        retries++;
                        if (window.headerScriptLoaded && typeof window.initializeHeader === 'function') {
                            window.initializeHeader();
                        } else if (retries < 10) {
                            setTimeout(checkAndInitialize, 100);
                        }
                    };
                    checkAndInitialize();
                };
                document.head.appendChild(script);
            });
    </script>

    <script src="../js/pageLoader.js"></script>
</body>

</html>
        