<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>My Policies - AVIMS</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark min-h-screen font-display text-slate-900 dark:text-slate-100 flex flex-col">
    <div id="header-container"></div>

    <main class="flex-1 max-w-[1200px] mx-auto w-full px-4 lg:px-10 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-black mb-2">My Active Policies</h1>
            <p class="text-slate-600 dark:text-slate-400 text-lg">Track active policies and download certificates.</p>
        </div>

        <!-- Search Component -->
        <div class="bg-white dark:bg-slate-900 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 mb-6">
            <div class="flex flex-col md:flex-row gap-3">
                <label class="flex flex-col flex-1">
                    <div class="flex w-full items-stretch rounded-lg h-14 bg-slate-100 dark:bg-slate-800 border border-transparent focus-within:border-primary transition-all">
                        <div class="text-slate-400 flex items-center justify-center pl-4 pr-2">
                            <span class="material-symbols-outlined">search</span>
                        </div>
                        <input id="policySearchInput"
                            class="form-input w-full bg-transparent border-none text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-0 text-base font-normal leading-normal"
                            placeholder="Enter Policy No or License Plate (e.g., ABC-1234)" />
                    </div>
                </label>
                <button onclick="searchPolicies()"
                    class="bg-primary text-white font-bold px-8 py-3 rounded-lg hover:bg-primary/90 transition-all flex items-center justify-center gap-2 h-14">
                    <span class="material-symbols-outlined">find_in_page</span>
                    Search Policy
                </button>
            </div>
            <button onclick="location.href='InsurancePoliciesList.html'" style="color: blue;"
                class="mt-4 text-sm text-slate-500 dark:text-slate-400 underline hover:text-slate-700 dark:hover:text-slate-300 transition-colors">
                Go to all Policies List
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="policiesGrid">
            <!-- Policy cards will be generated here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12 hidden">
            <span class="material-symbols-outlined text-6xl text-slate-300 dark:text-slate-600 mb-4 block">
                description
            </span>
            <h3 class="text-xl font-bold text-slate-600 dark:text-slate-400 mb-2">No Active Policies</h3>
            <p class="text-slate-500 dark:text-slate-400 mb-6">
                You don't have any active policies at the moment.
            </p>
            <a href="EstimateRequest.html" class="inline-flex items-center gap-2 text-primary font-bold hover:underline">
                <span class="material-symbols-outlined text-[20px]">add_circle</span>
                Get a Quote
            </a>
        </div>
    </main>

    <footer>
        <iframe id="footer-frame" src="../templates/footer.html"
            style="border: none; width: 100%; margin: 0; padding: 0; display: block; overflow: hidden;"
            frameborder="0"></iframe>
    </footer>

    <script>
        // Auto-adjust iframe height
        function resizeIframe(iframe) {
            try {
                const height = iframe.contentWindow.document.documentElement.scrollHeight;
                iframe.style.height = height + 'px';
            } catch (err) {
                console.log('Cannot access iframe content');
            }
        }

        const footerFrame = document.getElementById('footer-frame');
        if (footerFrame) {
            footerFrame.onload = function () {
                resizeIframe(footerFrame);
            };
        }

        window.addEventListener('resize', function () {
            if (footerFrame) resizeIframe(footerFrame);
        });
    </script>

    <script>
        const policyState = {
            policies: [],
            user: null
        };

        function getSessionUser() {
            const sessionStr = sessionStorage.getItem('user');
            const localStr = localStorage.getItem('user');
            const userStr = sessionStr || localStr;
            if (!userStr) return null;
            try {
                return JSON.parse(userStr);
            } catch {
                return null;
            }
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            const d = new Date(date);
            return d.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function getStatusBadge(status) {
            const statusMap = {
                'ACTIVE': { bg: 'bg-green-100', text: 'text-green-700', darkBg: 'dark:bg-green-900/30', darkText: 'dark:text-green-400' },
                'WAITING_PAYMENT': { bg: 'bg-yellow-100', text: 'text-yellow-700', darkBg: 'dark:bg-yellow-900/30', darkText: 'dark:text-yellow-400' },
                'CANCELLED': { bg: 'bg-red-100', text: 'text-red-700', darkBg: 'dark:bg-red-900/30', darkText: 'dark:text-red-400' },
                'LAPSED': { bg: 'bg-slate-100', text: 'text-slate-700', darkBg: 'dark:bg-slate-900/30', darkText: 'dark:text-slate-400' }
            };
            return statusMap[status] || statusMap['LAPSED'];
        }

        async function loadPolicies() {
            const user = getSessionUser();
            console.log('Current user:', user);
            console.log('User properties:', Object.keys(user || {}));
            
            if (!user) {
                console.error('No valid user found');
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            
            try {
                // Load all policies
                const response = await fetch('/api/policies');
                if (!response.ok) throw new Error(`Failed to load policies: ${response.status}`);
                
                const data = await response.json();
                console.log('API response:', data);
                
                // Handle different API response formats
                let policies = [];
                if (Array.isArray(data)) {
                    policies = data;
                } else if (data && Array.isArray(data.data)) {
                    // API response is { success: true, data: [...] }
                    policies = data.data;
                } else if (data && Array.isArray(data.value)) {
                    policies = data.value;
                } else if (data && Array.isArray(data.policies)) {
                    policies = data.policies;
                } else {
                    console.error('Cannot extract array from API response:', data);
                    document.getElementById('emptyState').classList.remove('hidden');
                    return;
                }
                
                console.log('Total policies extracted:', policies.length);
                
                // Debug: Log first policy structure
                if (policies.length > 0) {
                    console.log('First policy structure:', JSON.stringify(policies[0], null, 2));
                }
                
                // Filter by ACTIVE status and customer name
                const userName = user.customerName || user.name || user.userName || '';
                console.log('Filtering by customerName:', userName);
                
                policyState.policies = policies.filter(p => {
                    const isActive = p.status === 'ACTIVE';
                    const nameMatch = p.customerName === userName; // Exact match only
                    
                    console.log(`Policy ${p.policyNumber}: status=${p.status}, customerName=${p.customerName}, userName=${userName}, match=${nameMatch}`);
                    
                    return isActive && nameMatch;
                });
                
                console.log(`Found ${policyState.policies.length} ACTIVE policies`);
                console.log('Filtered policies:', policyState.policies);
                
                if (policyState.policies.length === 0) {
                    document.getElementById('emptyState').classList.remove('hidden');
                    document.getElementById('policiesGrid').innerHTML = '';
                } else {
                    document.getElementById('emptyState').classList.add('hidden');
                    renderPolicies();
                }
            } catch (err) {
                console.error('Error loading policies:', err);
                document.getElementById('emptyState').classList.remove('hidden');
            }
        }



        function searchPolicies() {
            const searchInput = document.getElementById('policySearchInput').value.toLowerCase();
            if (!searchInput) {
                renderPolicies();
                return;
            }

            const filtered = policyState.policies.filter(p => {
                const policyNum = p.policyNumber?.toLowerCase() || '';
                const licensePlate = p.vehicleSnapshot?.licensePlate?.toLowerCase() || '';
                return policyNum.includes(searchInput) || licensePlate.includes(searchInput);
            });

            const grid = document.getElementById('policiesGrid');
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-2 text-center py-12"><p class="text-slate-500">No policies found matching your search.</p></div>';
            } else {
                grid.innerHTML = filtered.map(policy => renderPolicyCard(policy)).join('');
            }
        }

        function renderPolicyCard(policy) {
            const badge = getStatusBadge(policy.status);
            // API uses policyStartDate/policyEndDate
            const startDate = formatDate(policy.policyStartDate);
            const endDate = formatDate(policy.policyEndDate);
            
            // API uses vehicleName, vehicleModel, vehicleNumber instead of vehicleSnapshot
            const vehicleInfo = policy.vehicleName ? `${policy.vehicleName}` : 'N/A';
            const licensePlate = policy.vehicleNumber || 'N/A';
            const coverageType = policy.insuranceType?.typeName || policy.coverageType || 'N/A';

            return `
                <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold ${badge.bg} ${badge.text} ${badge.darkBg} ${badge.darkText} mb-2">
                                    <span class="material-symbols-outlined text-[14px]">check_circle</span>
                                    ${policy.status}
                                </span>
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">${vehicleInfo}</h3>
                                <p class="text-slate-500 dark:text-slate-400 text-sm">Policy No: <span class="text-slate-900 dark:text-slate-200 font-semibold uppercase">${policy.policyNumber}</span></p>
                            </div>
                            <div class="bg-slate-100 dark:bg-slate-800 p-3 rounded-lg">
                                <span class="material-symbols-outlined text-primary text-[32px]">directions_car</span>
                            </div>
                        </div>
                        <div class="space-y-3 py-4 border-y border-slate-100 dark:border-slate-800">
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-500 dark:text-slate-400">Validity Period</span>
                                <span class="font-medium text-slate-900 dark:text-slate-200">${startDate} - ${endDate}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-500 dark:text-slate-400">Coverage Type</span>
                                <span class="font-medium text-slate-900 dark:text-slate-200">${coverageType}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-500 dark:text-slate-400">License Plate</span>
                                <span class="font-medium text-slate-900 dark:text-slate-200">${licensePlate}</span>
                            </div>
                        </div>
                        <div class="mt-6 flex gap-3">
                            <button onclick="downloadCertificate('${policy.policyId}')"
                                class="flex-1 bg-primary text-white text-sm font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-primary/90 transition-colors">
                                <span class="material-symbols-outlined text-[18px]">download</span>
                                Certificate
                            </button>
                            <a href="PolicyDetailView.html?id=${policy.policyId}"
                                class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white text-sm font-bold py-3 px-4 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors flex items-center justify-center">
                                View Details
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPolicies() {
            const grid = document.getElementById('policiesGrid');
            grid.innerHTML = policyState.policies.map(policy => renderPolicyCard(policy)).join('');
        }

        function downloadCertificate(policyId) {
            // Download PDF from API endpoint
            fetch(`/api/policies/${policyId}/policy-pdf`)
                .then(response => {
                    if (!response.ok) throw new Error('Failed to download certificate');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `policy-${policyId}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                })
                .catch(err => {
                    console.error('Error downloading certificate:', err);
                    alert('Failed to download certificate. Please try again.');
                });
        }

        // Load on page ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadPolicies);
        } else {
            loadPolicies();
        }
    </script>

    <script>
        // Load header fragment
        fetch('../templates/header.html')
            .then(response => response.text())
            .then(html => {
                const headerContainer = document.getElementById('header-container');
                headerContainer.innerHTML = html;
                
                // Load header.js script
                const headerScript = document.createElement('script');
                headerScript.src = '../js/header.js';
                headerScript.onload = function() {
                    setTimeout(() => {
                        if (window.initializeHeader) {
                            window.initializeHeader();
                        }
                        if (window.highlightActiveNav) {
                            window.highlightActiveNav();
                        }
                    }, 50);
                };
                document.head.appendChild(headerScript);
            })
            .catch(err => console.log('Error loading header:', err));
    </script>

    <script src="../js/pageLoader.js"></script>
</body>

</html>

