<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>My Notifications | AutoGuard Insurance</title>

    <script>
        tailwind = window.tailwind || {};
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: { display: ["Inter"] },
                },
            },
        };
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />

    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        /* Animation cho việc mở rộng thông báo */
        .notification-detail {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

            .notification-detail.open {
                max-height: 500px;
                opacity: 1;
                margin-top: 10px;
            }
    </style>
    <script src="../js/config.js"></script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-[#0d141b] dark:text-slate-50 transition-colors duration-200">

    <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">
        <div id="header-container"></div>

        <main class="max-w-[1000px] mx-auto px-4 pb-12 flex-1 pt-8 w-full">

            <div class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-3xl font-black text-[#0d141b] dark:text-white">Notifications</h1>
                    <p class="text-[#4c739a] dark:text-slate-400 mt-1">Updates on your policies and claims</p>
                </div>
                <button onclick="loadNotifications()" class="flex items-center gap-2 text-sm font-bold text-primary hover:bg-blue-50 px-3 py-2 rounded-lg transition">
                    <span class="material-symbols-outlined text-lg">refresh</span> Refresh
                </button>
            </div>

            <div id="notification-list" class="flex flex-col gap-4">
                <div class="text-center py-10 text-gray-500">
                    <span class="material-symbols-outlined animate-spin text-3xl mb-2">progress_activity</span>
                    <p>Loading notifications...</p>
                </div>
            </div>

            <template id="empty-state">
                <div class="flex flex-col items-center justify-center py-16 bg-white dark:bg-slate-900 rounded-2xl border border-[#e7edf3] dark:border-slate-800 shadow-sm text-center">
                    <div class="bg-blue-50 dark:bg-slate-800 p-4 rounded-full mb-4">
                        <span class="material-symbols-outlined text-4xl text-primary">notifications_off</span>
                    </div>
                    <h3 class="text-xl font-bold text-[#0d141b] dark:text-white">No notifications yet</h3>
                    <p class="text-[#4c739a] dark:text-slate-400 max-w-xs mt-2">We'll let you know when there are updates to your account.</p>
                </div>
            </template>

        </main>
    </div>

    <iframe id="footer-frame" src="../templates/footer.html" style="border: none; width: 100%; display: block;" frameborder="0"></iframe>

    <script>
        // Get userId from the user object in localStorage or sessionStorage
        let CURRENT_USER_ID = 1; // default to admin
        const userStr = localStorage.getItem('user') || sessionStorage.getItem('user');
        if (userStr) {
            try {
                const user = JSON.parse(userStr);
                CURRENT_USER_ID = user.userId || 1;
            } catch (e) {
                console.error('Error parsing user data:', e);
            }
        }
        const API_URL = (typeof API_BASE !== 'undefined') ? `${API_BASE}/notification` : "http://localhost:5169/api/notification";

        // 1. Hàm format thời gian (Ví dụ: "2 hours ago")
        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return "Just now";
        }

        // 2. Hàm gọi API lấy dữ liệu
        async function loadNotifications() {
            const container = document.getElementById('notification-list');

            try {
                const response = await fetch(`${API_URL}/user/${CURRENT_USER_ID}`);
                if (!response.ok) throw new Error("Failed to fetch");

                const responseData = await response.json();
                
                // Handle both array and object responses
                let notifications = [];
                if (Array.isArray(responseData)) {
                    notifications = responseData;
                } else if (responseData && responseData.notifications) {
                    notifications = responseData.notifications;
                }
                
                renderNotifications(notifications);

            } catch (error) {
                console.error(error);
                container.innerHTML = `<div class="text-red-500 text-center py-4">Failed to load notifications. Please try again later.</div>`;
            }
        }

        // 3. Hàm render HTML
        function renderNotifications(data) {
            const container = document.getElementById('notification-list');
            const emptyTemplate = document.getElementById('empty-state');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.appendChild(emptyTemplate.content.cloneNode(true));
                return;
            }

            data.forEach(item => {
                // Tạo thẻ div cho mỗi thông báo
                const div = document.createElement('div');
                // Style khác nhau nếu chưa đọc
                const bgClass = item.isRead ? 'bg-white dark:bg-slate-900 opacity-70' : 'bg-blue-50 dark:bg-slate-800 border-l-4 border-primary';
                const textClass = item.isRead ? 'font-medium' : 'font-bold';
                const iconColor = item.isRead ? 'text-gray-400' : 'text-primary';

                div.className = `group relative rounded-xl border border-[#e7edf3] dark:border-slate-800 p-5 cursor-pointer hover:shadow-md transition-all ${bgClass}`;

                div.innerHTML = `
                    <div class="flex gap-4 items-start" onclick="toggleRead(${item.notificationId}, this, ${item.isRead})">
                        <div class="mt-1 shrink-0">
                            <span class="material-symbols-outlined ${iconColor}">${item.isRead ? 'drafts' : 'mail'}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <h3 class="text-[#0d141b] dark:text-white text-lg ${textClass}">${item.title}</h3>
                                <span class="text-xs text-[#4c739a] font-medium whitespace-nowrap ml-2">${timeAgo(item.createdDate)}</span>
                            </div>
                            <p class="text-[#4c739a] dark:text-slate-400 text-sm mt-1 line-clamp-1 group-hover:line-clamp-none transition-all">
                                Click to read details...
                            </p>

                            <div id="detail-${item.notificationId}" class="notification-detail text-[#0d141b] dark:text-gray-300 text-sm pt-2 border-t border-gray-200 dark:border-gray-700 mt-2">
                                ${item.message}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 4. Hàm xử lý khi click vào thông báo (Mở rộng + Đánh dấu đã đọc)
        async function toggleRead(id, element, isAlreadyRead) {
            // Hiệu ứng UI mở rộng
            const detailBox = document.getElementById(`detail-${id}`);
            const isOpen = detailBox.classList.contains('open');

            // Toggle mở/đóng
            document.querySelectorAll('.notification-detail').forEach(el => el.classList.remove('open')); // Đóng cái khác lại
            if (!isOpen) detailBox.classList.add('open');

            // Gọi API đánh dấu đã đọc (chỉ gọi 1 lần nếu chưa đọc)
            if (!isAlreadyRead && !element.dataset.markedRead) {
                try {
                    await fetch(`${API_URL}/${id}/mark-read`, { method: 'PUT' });

                    // Cập nhật giao diện ngay lập tức
                    element.classList.remove('bg-blue-50', 'border-l-4', 'border-primary');
                    element.classList.add('bg-white', 'dark:bg-slate-900', 'opacity-70');

                    // Đổi icon
                    const icon = element.querySelector('.material-symbols-outlined');
                    icon.textContent = 'drafts';
                    icon.classList.remove('text-primary');
                    icon.classList.add('text-gray-400');

                    // Đánh dấu cờ để không gọi API lại
                    element.dataset.markedRead = "true";
                } catch (err) {
                    console.error("Lỗi đánh dấu đã đọc", err);
                }
            }
        }

        // Chạy khi load trang
        document.addEventListener('DOMContentLoaded', loadNotifications);
    </script>

    <script>
        function resizeIframe(iframe) {
            try {
                const height = iframe.contentWindow.document.documentElement.scrollHeight;
                iframe.style.height = height + 'px';
            } catch (err) {}
        }
        const footerFrame = document.getElementById('footer-frame');
        if (footerFrame) { footerFrame.onload = function () { resizeIframe(footerFrame); }; }
        window.addEventListener('resize', function () { if (footerFrame) resizeIframe(footerFrame); });

        // Header Loader
        fetch('../templates/header.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('header-container').innerHTML = html;
                const script = document.createElement('script');
                script.src = '../js/header.js';
                script.onload = () => {
                    if (window.initializeHeader) window.initializeHeader();
                };
                document.head.appendChild(script);
            });
    </script>
    <script src="../js/pageLoader.js"></script>
</body>

</html>
